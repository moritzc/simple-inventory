{% extends "base.html" %}

{% block title %}Inventar √úbersicht{% endblock %}

{% block content %}
<h1>Inventar √úbersicht</h1>

<form method="get" action="/" style="margin-bottom: 1rem;">
  <input type="text" name="q" placeholder="üîç Suche z.‚ÄØB. HDMI, Kabel..." value="{{ q }}">
  <button type="submit">Suchen</button>
</form>

<form method="post" action="/create-box" style="margin-bottom: 1rem;">
  <input type="text" name="name" placeholder="üì¶ Neue Box anlegen" required>
  <button type="submit">‚ûï Box hinzuf√ºgen</button>
</form>

<div style="margin-bottom: 1rem;">
  <a href="/export/json">‚¨áÔ∏è Export als JSON</a> |
  <a href="/export/csv">‚¨áÔ∏è Export als CSV</a> |
  <form method="post" action="/import" enctype="multipart/form-data" style="display:inline;"onsubmit="return confirm('Achtung: Der gesamte aktuelle Datenbestand wird gel√∂scht und durch die importierten Daten ersetzt. Vorgang fortsetzen?');">
    <input type="file" name="file" required>
    <button type="submit">‚¨ÜÔ∏è Import</button>
</form>
</div>

<ul>
  {% for entry in results %}
    <li style="margin-bottom: 1rem;" id="box-{{ entry.box.id }}">
      <strong class="box-name">
        <a href="/box/{{ entry.box.id }}">{{ entry.box.name }}</a>
        ({{ entry.box.items|length }} Inhalte)
      </strong>
      <!-- Bearbeiten-Button -->
      <button onclick="openEditBoxDialog({{ entry.box.id }}, '{{ entry.box.name|e }}')" style="margin-left: 0.5rem;">‚úèÔ∏è Bearbeiten</button>
      <!-- L√∂schen wie gehabt -->
      <form method="post" action="/box/{{ entry.box.id }}/delete" onsubmit="return confirm('Box wirklich l√∂schen? Alle Inhalte werden entfernt.')"
            style="display:inline;">
        <button type="submit" style="margin-left: 1rem;">üóëÔ∏è L√∂schen</button>
      </form>

      {% if entry.matches %}
        <ul style="margin-left: 1rem; font-style: italic; color: #ccc;">
          {% for item in entry.matches %}
            <li>{{ item.name }} ({{ item.quantity }})</li>
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {% else %}
    <li>Keine Boxen gefunden.</li>
  {% endfor %}
</ul>

<div id="editBoxDialog" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,30,0.8); z-index:100; align-items:center; justify-content:center;">
  <form id="editBoxForm" style="background:#232323; color:#eee; padding:2rem; border-radius:1rem; box-shadow:0 0 1.5rem #000; min-width:280px; max-width:95vw;">
    <h3>Box umbenennen</h3>
    <input type="hidden" name="edit_box_id" id="edit_box_id">
    <div style="margin-bottom:1em;">
      <label>Neuer Name:<br>
        <input type="text" name="edit_box_name" id="edit_box_name" required style="width:100%">
      </label>
    </div>
    <div style="display:flex; gap:1em; margin-top:1em;">
      <button type="submit">Speichern</button>
      <button type="button" onclick="closeEditBoxDialog()">Abbrechen</button>
    </div>
  </form>
</div>

<script>
function openEditBoxDialog(id, name) {
  document.getElementById('edit_box_id').value = id;
  document.getElementById('edit_box_name').value = name;
  document.getElementById('editBoxDialog').style.display = "flex";
}
function closeEditBoxDialog() {
  document.getElementById('editBoxDialog').style.display = "none";
}

document.getElementById('editBoxForm').onsubmit = async function(e) {
  e.preventDefault();
  const id = document.getElementById('edit_box_id').value;
  const name = document.getElementById('edit_box_name').value.trim();
  if (!name) return;
  const form = new URLSearchParams();
  form.append("name", name);
  try {
    const res = await fetch(`/box/${id}/edit`, {
      method: "POST",
      body: form
    });
    if (!res.ok) throw new Error();
    // Update im DOM:
    const boxDiv = document.getElementById(`box-${id}`);
    if (boxDiv) {
      const nameEl = boxDiv.querySelector(".box-name a");
      if (nameEl) nameEl.textContent = name;
    }
    closeEditBoxDialog();
  } catch {
    alert("Fehler beim Umbenennen.");
  }
};
</script>

{% endblock %}
